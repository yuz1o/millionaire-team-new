<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r flex flex-col">
        <div class="p-6 border-b">
            <h2 class="font-black text-xl text-indigo-600">My Subjects</h2>
        </div>
        <div id="subjectList" class="flex-1 overflow-y-auto p-4 space-y-2">
            </div>
        <div class="p-4 border-t">
            <input type="text" id="newSubjectName" placeholder="æ–°ã—ã„æ•™ç§‘å..." class="w-full p-2 text-sm border rounded-lg mb-2">
            <button onclick="addSubject()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold">+ æ•™ç§‘ã‚’è¿½åŠ </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <div class="max-w-3xl mx-auto">
            <header class="mb-8 flex justify-between items-end">
                <div>
                    <h1 id="currentSubjectTitle" class="text-4xl font-black text-slate-800">æ•™ç§‘ã‚’é¸æŠã—ã¦ãã ã•ã„</h1>
                    <p class="text-slate-400 font-bold uppercase tracking-widest text-xs mt-2">Study History & Generator</p>
                </div>
            </header>

            <div id="genForm" class="bg-white rounded-[2rem] p-8 shadow-sm border mb-12 hidden">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <select id="qType" class="p-3 bg-slate-100 rounded-xl font-bold">
                        <option>ä¸€å•ä¸€ç­”</option><option>è¨˜è¿°å¼</option><option>ç©´åŸ‹ã‚</option>
                    </select>
                    <input type="number" id="qCount" value="5" min="1" max="15" class="p-3 bg-slate-100 rounded-xl font-bold">
                </div>
                <input type="file" id="pdfFile" class="mb-4 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <button onclick="generate()" id="genBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black hover:bg-indigo-600 transition">æ–°ã—ã„å•é¡Œã‚’ç”Ÿæˆ</button>
            </div>

            <div id="loading" class="hidden text-center py-10"><p class="animate-pulse font-bold text-indigo-600">AIãŒæ€è€ƒä¸­...</p></div>
            <div id="resultList" class="space-y-6"></div>
        </div>
    </main>

    <script>
        let currentSubject = "";

        // æ•™ç§‘ä¸€è¦§ã‚’å–å¾—
        async function loadSubjects() {
            const res = await fetch('/get-subjects');
            const subjects = await res.json();
            const list = document.getElementById('subjectList');
            list.innerHTML = '';
            subjects.forEach(sub => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-3 rounded-xl font-bold transition ${currentSubject === sub ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`;
                btn.innerText = `ğŸ“ ${sub}`;
                btn.onclick = () => selectSubject(sub);
                list.appendChild(btn);
            });
        }

        // æ•™ç§‘ã‚’é¸æŠ
        async function selectSubject(name) {
            currentSubject = name;
            document.getElementById('currentSubjectTitle').innerText = name;
            document.getElementById('genForm').classList.remove('hidden');
            loadSubjects(); // å†æç”»
            
            // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            const res = await fetch(`/get-history/${name}`);
            const history = await res.json();
            renderQuestions(history);
        }

        // æ•™ç§‘ã‚’è¿½åŠ 
        function addSubject() {
            const name = document.getElementById('newSubjectName').value.trim();
            if (name) {
                selectSubject(name);
                document.getElementById('newSubjectName').value = '';
            }
        }

        function renderQuestions(data) {
            const list = document.getElementById('resultList');
            list.innerHTML = data.length ? '<h3 class="text-slate-400 font-black uppercase text-xs mb-4">History</h3>' : '';
            data.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-100 animate-in fade-in";
                card.innerHTML = `
                    <p class="text-xs font-black text-indigo-400 mb-2">#${q.id || i+1}</p>
                    <h3 class="text-lg font-bold text-slate-800 mb-4">${q.question}</h3>
                    <div class="p-4 bg-slate-50 rounded-xl text-sm">
                        <p class="font-bold text-slate-700">A: ${q.answer}</p>
                        <p class="text-slate-500 mt-2">${q.explanation}</p>
                    </div>
                `;
                list.appendChild(card);
            });
            if (window.MathJax) MathJax.typesetPromise();
        }

        async function generate() {
            if (!currentSubject) return alert("æ•™ç§‘ã‚’é¸æŠã—ã¦ãã ã•ã„");
            const fileInput = document.getElementById('pdfFile');
            const loading = document.getElementById('loading');
            
            loading.classList.remove('hidden');
            
            const formData = new FormData();
            if(fileInput.files[0]) formData.append('file', fileInput.files[0]);
            formData.append('subject', currentSubject);
            formData.append('type', document.getElementById('qType').value);
            formData.append('count', document.getElementById('qCount').value);

            try {
                const res = await fetch('/generate-questions', { method: 'POST', body: formData });
                await selectSubject(currentSubject); // ç”Ÿæˆå¾Œã«å±¥æ­´ã”ã¨å†èª­ã¿è¾¼ã¿
            } catch (err) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                loading.classList.add('hidden');
            }
        }

        window.onload = loadSubjects;
    </script>
</body>
</html>
