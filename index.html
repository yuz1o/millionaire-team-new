<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Gen v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            chtml: { displayAlign: 'left' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; min-height: 100vh; }
        .tab-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="py-12 px-4">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-[2.5rem] shadow-2xl p-8 md:p-12 border border-slate-100">
            <header class="text-center mb-10">
                <div class="inline-flex p-4 bg-indigo-50 rounded-3xl mb-4 text-indigo-600">
                    <i data-lucide="sparkles" class="w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-800">AI Study Gen <span class="text-indigo-600">v3.1</span></h1>
                <p class="text-slate-400 text-sm mt-1 uppercase tracking-tighter">Gemini 3 Flash Engine</p>
            </header>

            <div class="mb-8">
                <label class="block text-xs font-black text-slate-400 uppercase mb-2 ml-1">Subject Name</label>
                <input type="text" id="subject" placeholder="例: 数学II" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-indigo-500 text-slate-700 font-semibold transition">
            </div>

            <div class="mb-8">
                <label class="block text-xs font-black text-slate-400 uppercase mb-3 ml-1">Question Style</label>
                <div class="flex bg-slate-100 p-1.5 rounded-2xl" id="typeContainer">
                    <button onclick="setType('一問一答', this)" class="flex-1 py-3 text-sm font-bold rounded-xl transition tab-active">一問一答</button>
                    <button onclick="setType('記述式', this)" class="flex-1 py-3 text-sm font-bold rounded-xl transition text-slate-500">記述式</button>
                    <button onclick="setType('穴埋め', this)" class="flex-1 py-3 text-sm font-bold rounded-xl transition text-slate-500">穴埋め</button>
                </div>
                <input type="hidden" id="selectedType" value="一問一答">
            </div>

            <div class="mb-10 px-1">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-black text-slate-400 uppercase">Question Count</label>
                    <span id="countVal" class="text-3xl font-black text-indigo-600">5</span>
                </div>
                <input type="range" id="count" min="1" max="15" value="5" class="w-full h-3 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="document.getElementById('countVal').innerText=this.value">
            </div>

            <div class="mb-10 group relative border-4 border-dotted border-slate-100 rounded-[2rem] p-8 text-center hover:bg-indigo-50/30 transition-all cursor-pointer">
                <input type="file" id="pdfFile" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer">
                <div class="text-slate-300 group-hover:text-indigo-400 transition-colors">
                    <i data-lucide="cloud-upload" class="w-12 h-12 mx-auto mb-3"></i>
                    <p id="fileName" class="text-sm font-bold">資料(PDF)をここへ</p>
                </div>
            </div>

            <button onclick="generate()" id="genBtn" class="w-full bg-slate-900 hover:bg-indigo-600 text-white font-black py-5 rounded-[1.5rem] shadow-2xl transition-all active:scale-95 flex justify-center items-center gap-3 text-lg">
                問題を生成する
            </button>
        </div>

        <div id="loading" class="hidden mt-12 text-center">
            <div class="inline-block animate-bounce p-3 bg-white rounded-full shadow-lg mb-4">
                <i data-lucide="brain" class="text-indigo-600 w-8 h-8"></i>
            </div>
            <p class="text-slate-500 font-bold">Gemini 3 が分析しています...</p>
        </div>

        <div id="resultList" class="mt-12 space-y-8"></div>
    </div>

    <script>
        lucide.createIcons();

        function setType(type, btn) {
            document.getElementById('selectedType').value = type;
            const buttons = document.querySelectorAll('#typeContainer button');
            buttons.forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-slate-500');
            });
            btn.classList.add('tab-active');
            btn.classList.remove('text-slate-500');
        }

        document.getElementById('pdfFile').onchange = function() {
            if(this.files[0]) document.getElementById('fileName').innerText = this.files[0].name;
        };

        async function generate() {
            const fileInput = document.getElementById('pdfFile');
            const resultList = document.getElementById('resultList');
            const loading = document.getElementById('loading');
            const genBtn = document.getElementById('genBtn');

            if (!fileInput.files[0]) return alert("PDFを選択してください");

            loading.classList.remove('hidden');
            resultList.innerHTML = '';
            genBtn.disabled = true;
            genBtn.classList.add('opacity-50');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('subject', document.getElementById('subject').value);
            formData.append('type', document.getElementById('selectedType').value);
            formData.append('count', document.getElementById('count').value);

            try {
                // RenderのURLに合わせて調整してください
                const response = await fetch('/generate-questions', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    alert("エラー: " + data.error);
                    return;
                }
                
                if (!Array.isArray(data)) {
                    alert("エラー: AIからの回答を読み取れませんでした。");
                    return;
                }

                data.forEach((q, i) => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-8 rounded-[2rem] shadow-xl border border-slate-50 animate-in fade-in slide-in-from-bottom-4 duration-500";
                    card.innerHTML = `
                        <div class="flex gap-5">
                            <span class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-2xl flex items-center justify-center font-black">0${i+1}</span>
                            <div class="flex-1">
                                <h3 class="text-xl font-extrabold text-slate-800 mb-6 leading-relaxed">${q.question}</h3>
                                <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.innerText = this.innerText === '解答を見る' ? '解答を隠す' : '解答を見る';" 
                                        class="text-xs font-black uppercase tracking-widest text-indigo-600 border-2 border-indigo-50 px-6 py-2 rounded-full hover:bg-indigo-50 transition">
                                    解答を見る
                                </button>
                                <div class="hidden mt-6 p-6 bg-slate-50 rounded-2xl border-l-4 border-indigo-600">
                                    <p class="font-bold text-slate-800 mb-2">A: ${q.answer}</p>
                                    <p class="text-sm text-slate-500 leading-relaxed">${q.explanation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    resultList.appendChild(card);
                });

                // 数式のレンダリングを実行
                if (window.MathJax) {
                    MathJax.typesetPromise();
                }

            } catch (err) {
                alert("通信エラーが発生しました: " + err.message);
            } finally {
                loading.classList.add('hidden');
                genBtn.disabled = false;
                genBtn.classList.remove('opacity-50');
            }
        }
    </script>
</body>
</html>
